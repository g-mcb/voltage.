<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>voltage. - chat</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/1.0.21/vue.js"></script>
    <script src="https://cdn.firebase.com/js/client/2.4.2/firebase.js"></script>
    <script src="https://cdn.jsdelivr.net/vuefire/1.0.0/vuefire.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-router/0.7.11/vue-router.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #003ba8;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      #vue {
        width: 100%;
        max-width: 600px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,.25);
        overflow: hidden;
      }

      h1 {
        margin: 0;
        padding: 20px;
        background-color: #002263;
        color: white;
        text-align: center;
        font-size: 2.5em;
      }

      .messagesWrapper {
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        border-bottom: 1px solid #d0d6e5;
      }

      .message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 6px;
      }

      .message span {
        font-size: .85em;
        color: #555;
      }

      .message p {
        margin: 0;
      }

      .message[data-person="Me"] {
        background-color: #002263;
        color: white;
        text-align: right;
      }

      .message[data-person="Me"] span {
        color: #cfd6ff;
      }

      .message:not([data-person="Me"]) {
        background-color: #e3e8f5;
      }

      input {
        padding: 10px;
        border: 1px solid #bbb;
        border-radius: 4px;
        width: calc(100% - 90px);
        margin: 10px;
      }

      button {
        padding: 10px;
        border: none;
        background-color: #002263;
        color: white;
        border-radius: 4px;
        cursor: pointer;
      }

      button:hover {
        background-color: #001742;
      }

      .usersTyping,
      .usersOnline {
        color: #002263;
        font-size: .9em;
        margin-left: 10px;
      }

      .users {
        margin-left: 10px;
        font-size: .85em;
      }
    </style>
  </head>

  <body>
    <div id="vue">
      <h1>voltage. chat</h1>
      <router-view></router-view>
    </div>

    <script>
      var firebaseRef = new Firebase("https://weaver-codepen-demo.firebaseio.com/");
      var messageRef = firebaseRef.child("messages");
      var presenceRef = firebaseRef.child(".info/connected");
      var usersRef = firebaseRef.child("users");
      var userRef = usersRef.push();
      var myKey = "";

      var newMessage = { text: "", username: "" };

      var messenger = Vue.extend({
        template:
          '<div>' +
            '<div class="messagesWrapper">' +
              '<div class="message" v-for="message in messages" data-person="{{ message.username | isMyMessage }}">' +
                '<span>{{ message.username | isMyMessage }}</span>' +
                '<p>{{ message.text }}</p>' +
              '</div>' +
              '<p class="usersTyping" v-for="user in users">{{ user | isTyping }}</p>' +
            '</div>' +
            '<input @keyup.enter="addMessage()" v-model="newMessage.text" placeholder="Type your message...">' +
            '<button @click="addMessage()">Send</button>' +
            '<h3 class="usersOnline">Users Online: {{ users.length }}</h3>' +
            '<p class="users" v-for="user in users">{{ user.name | isMyUsername }}</p>' +
          '</div>',

        ready: function () {
          var self = this;
          presenceRef.on("value", function (snap) {
            if (snap.val()) {
              userRef.set({ online: true, name: self.newMessage.username, typing: false }, function () {
                myKey = self.users[self.users.length - 1][".key"];
              });
              userRef.onDisconnect().remove();
            }
          });
        },

        data: function () {
          return { newMessage: newMessage };
        },

        firebase: {
          messages: messageRef.limitToLast(25),
          users: usersRef
        },

        methods: {
          addMessage: function () {
            if (this.newMessage.text.trim()) {
              messageRef.push({
                text: this.newMessage.text,
                username: this.newMessage.username
              });
              this.newMessage.text = "";
            }
          }
        },

        filters: {
          isMyMessage: function (name) {
            return name === this.newMessage.username ? "Me" : name;
          },
          isTyping: function (user) {
            if (user.typing && user.name !== this.newMessage.username) {
              return user.name + " is typing...";
            }
          }
        }
      });

      var nameForm = Vue.extend({
        template:
          '<div>' +
            '<h2>Whatâ€™s your username?</h2>' +
            '<input @keyup.enter="go()" v-model="newMessage.username">' +
            '<button @click="go()">Continue</button>' +
          '</div>',
        data: function () {
          return { newMessage: newMessage };
        },
        methods: {
          go: function () {
            if (this.newMessage.username.trim()) router.go("/messenger");
          }
        }
      });

      Vue.filter("isMyUsername", function (name) {
        return name === newMessage.username ? name + " (Me)" : name;
      });

      var router = new VueRouter();
      router.map({
        "/": { component: nameForm },
        "/messenger": { component: messenger }
      });
      router.start(Vue, "#vue");
    </script>
  </body>
</html>
